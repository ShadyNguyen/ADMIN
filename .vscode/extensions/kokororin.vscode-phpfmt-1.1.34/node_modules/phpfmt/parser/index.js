var fs = require('fs');

var parser = {
  MODE_REGEX: 'mode_regex',
  MODE_PARSER: 'mode_parser'
};

parser.getPasses = function (phpfmt, mode) {
  var code = fs.readFileSync(phpfmt.pharPath);
  var passes = [];

  if (mode === parser.MODE_REGEX) {
    var passRegex =
      /class\s+(\w+)\s+extends\s+(AdditionalPass|FormatterPass)\s+\{/g;

    let match;
    while ((match = passRegex.exec(code)) !== null) {
      var pass = match[1];
      passes.push(pass);
    }
    passes = passes.filter(function (pass) {
      return pass !== 'AdditionalPass';
    });
  } else if (mode === parser.MODE_PARSER) {
    var phpParser = new (require('php-parser'))({
      ast: {
        withPositions: true
      }
    });

    var ast = phpParser.parseCode(code);

    var traverse = function (node) {
      if (node && typeof node === 'object') {
        if (
          node.kind === 'class' &&
          node.extends &&
          (node.extends.name === 'AdditionalPass' ||
            node.extends.name === 'FormatterPass')
        ) {
          passes.push(node.name.name);
        } else {
          for (var prop in node) {
            traverse(node[prop]);
          }
        }
      }
    };
    traverse(ast);
  } else {
    throw new Error('Unknown mode');
  }

  return passes;
};

parser.default = parser;

module.exports = exports = parser;
